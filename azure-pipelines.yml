trigger:
  - main

pool:
  name: "Default"

steps:
  - script: |
      if python3 -m venv .venv --clear; then
        .venv/bin/python -m pip install --upgrade pip
        .venv/bin/python -m pip install -r requirements.txt
        echo "##vso[task.setvariable variable=PYTHON_CMD].venv/bin/python"
      else
        echo "venv unavailable; using system pip with --break-system-packages"
        python3 -m pip install --break-system-packages --upgrade pip
        python3 -m pip install --break-system-packages -r requirements.txt
        echo "##vso[task.setvariable variable=PYTHON_CMD]python3"
      fi
    displayName: "Install dependencies"

  - script: |
      $(PYTHON_CMD) -m pytest -q
    displayName: "Run Python tests"

  - task: GoTool@0
    inputs:
      version: '1.24.1'
    displayName: "Install Go"

  - script: |
      cd microservices-go-starter-main
      curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
      $(go env GOPATH)/bin/golangci-lint run ./...
    displayName: "Run Go Lint (RAPS Rules)"

  - script: |
      cd microservices-go-starter-main
      go test -v ./...
    displayName: "Run Go Tests (RAPS Quality)"
